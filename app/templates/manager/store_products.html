{% extends 'base.html' %}
{% block title %}Товари у магазині — ZLAGODA{% endblock %}
{% set arrow = {'asc':'↑','desc':'↓'} %}

{% block content %}
<h2 class="mb-4">Товари у магазині</h2>

{# навігація #}
<p>
  <a href="{{ url_for('manager.products') }}"
     class="btn btn-outline-primary mb-3">
    → Типи товарів
  </a>
  <a href="{{ url_for('manager.new_store_product') }}"
     class="btn btn-primary mb-3 ms-2">
    + Додати товар
  </a>
</p>

{# флеші #}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, msg in messages %}
      <div class="alert alert-{{ category }} mt-3">{{ msg }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

{# фільтри #}
<form method="get" class="mb-3">
  <div class="row g-3 align-items-end">
    <div class="col-md-3">
      <label class="form-label">Категорія</label>
      <select name="category" class="form-select">
        <option value="">Усі категорії</option>
        {% for c in categories %}
          <option value="{{ c.name }}" {% if c.name==category %}selected{% endif %}>
            {{ c.name }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Акційність</label>
      <select name="promo" class="form-select">
        <option value=""  {% if promo==None %}selected{% endif %}>Усі</option>
        <option value="1" {% if promo=='1' %}selected{% endif %}>Акційні</option>
        <option value="0" {% if promo=='0' %}selected{% endif %}>Не акційні</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Пошук</label>
      <div class="input-group">
        <select name="field" class="form-select" style="max-width:35%;">
          <option value="name"            {% if field=='name' %}selected{% endif %}>Назва</option>
          <option value="upc"             {% if field=='upc' %}selected{% endif %}>UPC</option>
        </select>
        <input type="text" name="search" class="form-control"
               placeholder="Введіть запит…" value="{{ search or '' }}">
      </div>
    </div>
    <div class="col-auto">
      <button class="btn btn-primary">Застосувати</button>
      <a href="{{ url_for('manager.store_products') }}" class="btn btn-secondary ms-2">Скинути</a>
    </div>
  </div>
</form>

{# таблиця товарів #}
{% if store_products %}
  <table class="table table-striped">
    <thead>
      <tr>
        {% for col,label in [
          ('upc','UPC'),
          ('name','Назва'),
          ('characteristics','Опис'),
          ('category','Категорія'),
          ('price','Ціна'),
          ('quantity','Кількість'),
          ('promotional','Акційний')
        ] %}
          <th>
            <a href="{{ url_for('manager.store_products',
                                 sort_by=col,
                                 order=('desc' if sort_by==col and order=='asc' else 'asc'),
                                 category=category,
                                 promo=promo,
                                 field=field,
                                 search=search) }}">
              {{ label }} {% if sort_by==col %}{{ arrow[order] }}{% endif %}
            </a>
          </th>
        {% endfor %}
        <th>Дії</th>
      </tr>
    </thead>
    <tbody>
      {% for p in store_products %}
        <tr>
          <td>{{ p.upc }}</td>
          <td>{{ p.name }}</td>
          <td>{{ p.characteristics }}</td>
          <td>{{ p.category }}</td>
          <td>{{ '%.2f'|format(p.price) }}</td>
          <td>{{ p.quantity }}</td>
          <td>{{ 'Так' if p.promotional else 'Ні' }}</td>
          <td>
            <a href="{{ url_for('manager.edit_store_product', upc=p.upc) }}"
               class="btn btn-sm btn-outline-secondary">Редагувати</a>
            <form method="post"
                  action="{{ url_for('manager.delete_store_product_route', upc=p.upc) }}"
                  class="d-inline" onsubmit="return confirm('Видалити товар?');">
              <button class="btn btn-sm btn-outline-danger">✕</button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <p>Немає товарів за заданими критеріями.</p>
{% endif %}
{% endblock %}
