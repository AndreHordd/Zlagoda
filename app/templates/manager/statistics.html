{% extends 'base.html' %}
{% block title %}Статистика продажів — ZLAGODA{% endblock %}

{% block content %}
<h2 class="mb-4">Статистика продажів</h2>

<!-- ═══════════ ФОРМА ПАРАМЕТРІВ ═══════════ -->
<form method="get" class="mb-4">
  <!-- ── 1-й ряд: касир / товар / період / submit ── -->
  <div class="row g-3 align-items-end">
    <!-- Касир -->
    <div class="col-md-3">
      <label class="form-label">Касир</label>
      <select name="cashier" class="form-select">
        <option value="all" {% if not cashier_id %}selected{% endif %}>Усі касири</option>
        {% for c in cashiers %}
          <option value="{{ c.id }}" {% if cashier_id==c.id %}selected{% endif %}>
            {{ c.surname }} {{ c.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Товар (випадачка list-group) -->
    <div class="col-md-3 position-relative">
      <label class="form-label">Товар (UPC або назва)</label>
      <input  type="text"
              id="product-input"
              name="product"
              class="form-control"
              placeholder="Почніть вводити…"
              autocomplete="off"
              value="{{ product_input or '' }}">

      <div id="product-list"
           class="list-group position-absolute shadow-sm bg-white"
           style="max-height:200px; overflow-y:auto; display:none; z-index:1000;">
        {% for p in products %}
          <button type="button"
                  class="list-group-item list-group-item-action"
                  data-upc="{{ p.upc }}"
                  data-name="{{ p.name }}">
            {{ p.name }} — {{ "%.2f"|format(p.price) }}
          </button>
        {% endfor %}
      </div>
    </div>

    <!-- Період -->
    <div class="col-md-3">
      <label class="form-label">Період</label>
      <select name="period" id="period-select" class="form-select">
        <option value="day"   {% if period=='day'   %}selected{% endif %}>За день</option>
        <option value="7d"    {% if period=='7d'    %}selected{% endif %}>7 днів</option>
        <option value="month" {% if period=='month' %}selected{% endif %}>Місяць</option>
        <option value="year"  {% if period=='year'  %}selected{% endif %}>Рік</option>
        <option value="all"   {% if period=='all'   %}selected{% endif %}>Весь час</option>
        <option value="custom"{% if period=='custom'%}selected{% endif %}>Свій період</option>
      </select>
    </div>

    <div class="col-auto">
      <button class="btn btn-primary">Порахувати</button>
    </div>
  </div>

  <!-- ── 2-й ряд: Від / До (показуємо лише для custom) ── -->
  <div class="row g-3 mt-2">
    <div class="col-md-2" id="from-col">
      <label class="form-label">Від</label>
      <input type="date" name="from" id="from-date"
             class="form-control" value="{{ d_from }}">
    </div>
    <div class="col-md-2" id="to-col">
      <label class="form-label">До</label>
      <input type="date" name="to" id="to-date"
             class="form-control" value="{{ d_to }}">
    </div>
  </div>
</form>

<!-- ═══════════ КАРТКИ РЕЗУЛЬТАТІВ ═══════════ -->
<div class="row g-4 mt-2">
  <div class="col-md-4">
    <div class="card stat-card border-primary shadow-sm h-100 text-center">
      <div class="stat-card__title bg-primary text-white">
        Сума продажів касира
      </div>
      <div class="card-body d-flex flex-column justify-content-center">
        <p class="stat-card__value">
          {% if total_by_cashier is not none %}
            {{ "%.2f"|format(total_by_cashier) }} ₴
          {% else %}&mdash;{% endif %}
        </p>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card stat-card border-success shadow-sm h-100 text-center">
      <div class="stat-card__title bg-success text-white">
        Сума продажів усіх касирів
      </div>
      <div class="card-body d-flex flex-column justify-content-center">
        <p class="stat-card__value">
          {% if total_all is not none %}
            {{ "%.2f"|format(total_all) }} ₴
          {% else %}&mdash;{% endif %}
        </p>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card stat-card border-info shadow-sm h-100 text-center">
      <div class="stat-card__title bg-info text-white">
        Продано одиниць товару
      </div>
      <div class="card-body d-flex flex-column justify-content-center">
        <p class="stat-card__value">
          {% if qty_sold is not none %}
            {{ qty_sold }}
          {% else %}&mdash;{% endif %}
        </p>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════ JS ═══════════ -->
<script>
/* ---- list-group автодоповнення ---- */
document.addEventListener('DOMContentLoaded', () => {
  const inp  = document.getElementById('product-input');
  const list = document.getElementById('product-list');
  const btns = Array.from(list.children);

  function filter(){
    const term = inp.value.trim().toLowerCase();
    let any=false;
    btns.forEach(b=>{
      const txt=(b.dataset.name+' '+b.dataset.upc).toLowerCase();
      const ok = txt.includes(term);
      b.style.display = ok?'':'none';
      if(ok) any=true;
    });
    list.style.display = any ? 'block' : 'none';
  }
  inp.addEventListener('input',filter);
  inp.addEventListener('focus',filter);
  document.addEventListener('click',e=>{
    if(!inp.contains(e.target)&&!list.contains(e.target))
      list.style.display='none';
  });
  btns.forEach(b=>b.addEventListener('click',()=>{
    inp.value = b.dataset.upc;    /* можна .dataset.name */
    list.style.display='none';
  }));

  /* ---- показ/прихов. полів дат ---- */
  const sel = document.getElementById('period-select');
  const fromCol=document.getElementById('from-col');
  const toCol  =document.getElementById('to-col');
  function toggle(){
    const p=sel.value;
    const show = p==='custom';
    fromCol.classList.toggle('d-none',!show);
    toCol.classList.toggle('d-none',!show);
  }
  sel.addEventListener('change',toggle);
  toggle();   // init
});
</script>
{% endblock %}
