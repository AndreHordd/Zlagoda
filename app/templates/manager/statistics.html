{% extends 'base.html' %}
{% block title %}Статистика продажів — ZLAGODA{% endblock %}

{% block content %}
<h2 class="mb-4">Статистика продажів</h2>

<!-- ═══════════ ФОРМА ПАРАМЕТРІВ ═══════════ -->
<form method="get" class="mb-4">
  <!-- ── 1-й ряд: касир / товар / період / submit ── -->
  <div class="row g-3 align-items-end">
    <!-- Касир -->
    <div class="col-md-3">
      <label class="form-label">Касир</label>
      <select name="cashier" class="form-select">
        <option value="all" {% if not cashier_id %}selected{% endif %}>Усі касири</option>
        {% for c in cashiers %}
          <option value="{{ c.id }}" {% if cashier_id==c.id %}selected{% endif %}>
            {{ c.surname }} {{ c.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Товар (випадачка list-group) -->
    <div class="col-md-3 position-relative">
      <label class="form-label">Товар (UPC або назва)</label>
      <input  type="text"
              id="product-input"
              name="product"
              class="form-control"
              placeholder="Почніть вводити…"
              autocomplete="off"
              value="{{ product_input or '' }}">

      <div id="product-list"
           class="list-group position-absolute shadow-sm bg-white"
           style="max-height:200px; overflow-y:auto; display:none; z-index:1000;">
        {% for p in products %}
          <button type="button"
                  class="list-group-item list-group-item-action"
                  data-upc="{{ p.upc }}"
                  data-name="{{ p.name }}">
            {{ p.name }} — {{ "%.2f"|format(p.price) }}
          </button>
        {% endfor %}
      </div>
    </div>

    <!-- Період -->
    <div class="col-md-3">
      <label class="form-label">Період</label>
      <select name="period" id="period-select" class="form-select">
        <option value="day"   {% if period=='day'   %}selected{% endif %}>За день</option>
        <option value="7d"    {% if period=='7d'    %}selected{% endif %}>7 днів</option>
        <option value="month" {% if period=='month' %}selected{% endif %}>Місяць</option>
        <option value="year"  {% if period=='year'  %}selected{% endif %}>Рік</option>
        <option value="all"   {% if period=='all'   %}selected{% endif %}>Весь час</option>
        <option value="custom"{% if period=='custom'%}selected{% endif %}>Свій період</option>
      </select>
    </div>

    <div class="col-auto">
      <button class="btn btn-primary">Порахувати</button>
    </div>
  </div>

  <!-- ── 2-й ряд: Від / До (показуємо лише для custom) ── -->
  <div class="row g-3 mt-2">
    <div class="col-md-2" id="from-col">
      <label class="form-label">Від</label>
      <input type="date" name="from" id="from-date"
             class="form-control" value="{{ d_from }}">
    </div>
    <div class="col-md-2" id="to-col">
      <label class="form-label">До</label>
      <input type="date" name="to" id="to-date"
             class="form-control" value="{{ d_to }}">
    </div>
  </div>
</form>

<!-- ═══════════ КАРТКИ РЕЗУЛЬТАТІВ ═══════════ -->
<div class="row g-4 mt-2">
  <div class="col-md-4">
    <div class="card stat-card border-primary shadow-sm h-100 text-center">
      <div class="stat-card__title bg-primary text-white">
        Сума продажів касира
      </div>
      <div class="card-body d-flex flex-column justify-content-center">
        <p class="stat-card__value">
          {% if total_by_cashier is not none %}
            {{ '%.2f'|format(total_by_cashier) }} ₴
          {% else %}&mdash;{% endif %}
        </p>
      </div>
    </div>
  </div>

  <div class="col-md-4">
  <div class="card stat-card border-success shadow-sm h-100 text-center">
    <div class="stat-card__title bg-success text-white">
      Сума продажів касирів
    </div>
    <div class="card-body d-flex flex-column justify-content-center">
      <p class="stat-card__value">
        {{ '%.2f'|format(total_all) }} ₴
      </p>
    </div>
  </div>
</div>


  <div class="col-md-4">
    <div class="card stat-card border-info shadow-sm h-100 text-center">
      <div class="stat-card__title bg-info text-white">
        Продано одиниць товару
      </div>
      <div class="card-body d-flex flex-column justify-content-center">
        <p class="stat-card__value">
          {% if qty_sold is not none %}
            {{ qty_sold }}
          {% else %}&mdash;{% endif %}
        </p>
      </div>
    </div>
  </div>
</div>
<hr class="my-4">

<!-- ═══════════ ДЕТАЛЬНІ ТАБЛИЦІ ═══════════ -->
<div class="accordion" id="stats-accordion">

  <!-- ① Продажі по касирах -->
  <div class="accordion-item">
    <h2 class="accordion-header" id="h-cashiers">
      <button class="accordion-button" type="button" data-bs-toggle="collapse"
              data-bs-target="#c-cashiers">Категорії та обсяги продажів касирів (весь час)</button>
    </h2>
    <div id="c-cashiers" class="accordion-collapse collapse show"
         data-bs-parent="#stats-accordion">
      <div class="accordion-body p-0">
<table class="table table-striped">
  <thead class="table-light">
    <tr>
      <th>#</th>
      <th>ID</th>
      <th>Прізвище Імʼя</th>
      <th>Категорій</th>
      <th>Од. продано</th>
    </tr>
  </thead>
  <tbody>
    {% for r in cashier_stats[:5] %}
    <tr>
      <td>{{ loop.index }}</td>
      <td>{{ r.id_employee }}</td>
      <td>{{ r.empl_surname }} {{ r.empl_name }}</td>
      <td>{{ r.num_categories_sold }}</td>
      <td>{{ r.total_items_sold }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

      </div>
    </div>
  </div>

  <!-- ② Статистика цін у категоріях -->
  <div class="accordion-item">
    <h2 class="accordion-header" id="h-price">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#c-price">Мін/Макс/Середня ціна у «популярних» категоріях</button>
    </h2>
    <div id="c-price" class="accordion-collapse collapse"
         data-bs-parent="#stats-accordion">
      <div class="accordion-body p-0">
        <table class="table table-striped m-0">
          <thead class="table-light">
            <tr>
              <th>#</th><th>Категорія</th><th>Min</th><th>Max</th>
              <th>Avg</th><th>Усього шт.</th>
            </tr>
          </thead>
          <tbody>
          {% for r in price_table %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ r.category_name }}</td>
              <td>{{ '%.2f'|format(r.min_price) }}</td>
              <td>{{ '%.2f'|format(r.max_price) }}</td>
              <td>{{ '%.2f'|format(r.avg_price) }}</td>
              <td>{{ r.total_units }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ③ Касири, в усіх чеках яких є товар категорії -->
  <div class="accordion-item">
    <h2 class="accordion-header" id="h-loyal">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#c-loyal">Касири, у кожному чеку яких присутні «Молочні» товари</button>
    </h2>
    <div id="c-loyal" class="accordion-collapse collapse"
         data-bs-parent="#stats-accordion">
      <div class="accordion-body p-0">
        <ul class="list-group list-group-flush">
          {% for c in loyal_cashiers %}
            <li class="list-group-item">{{ c.empl_surname }} {{ c.empl_name }} — {{ c.id_employee }}</li>
          {% else %}
            <li class="list-group-item text-muted">Немає таких касирів.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <!-- ④ Категорії без акційних і без великого залишку -->
  <div class="accordion-item">
    <h2 class="accordion-header" id="h-rare">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#c-rare">Категорії без акцій та із малим залишком</button>
    </h2>
    <div id="c-rare" class="accordion-collapse collapse"
         data-bs-parent="#stats-accordion">
      <div class="accordion-body p-0">
        <ul class="list-group list-group-flush">
          {% for cat in rare_cats %}
            <li class="list-group-item">{{ cat.category_name }}</li>
          {% else %}
            <li class="list-group-item text-muted">Усі категорії мають акції або великий stock.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

</div> <!-- /accordion -->

<!-- ═══════════ JS ═══════════ -->
<script>
/* ---- list-group автодоповнення ---- */
document.addEventListener('DOMContentLoaded', () => {
  const inp  = document.getElementById('product-input');
  const list = document.getElementById('product-list');
  const btns = Array.from(list.children);

  function filter(){
    const term = inp.value.trim().toLowerCase();
    let any=false;
    btns.forEach(b=>{
      const txt=(b.dataset.name+' '+b.dataset.upc).toLowerCase();
      const ok = txt.includes(term);
      b.style.display = ok?'':'none';
      if(ok) any=true;
    });
    list.style.display = any ? 'block' : 'none';
  }
  inp.addEventListener('input',filter);
  inp.addEventListener('focus',filter);
  document.addEventListener('click',e=>{
    if(!inp.contains(e.target)&&!list.contains(e.target))
      list.style.display='none';
  });
  btns.forEach(b=>b.addEventListener('click',()=>{
    inp.value = b.dataset.upc;    /* можна .dataset.name */
    list.style.display='none';
  }));

  /* ---- показ/прихов. полів дат ---- */
  const sel = document.getElementById('period-select');
  const fromCol=document.getElementById('from-col');
  const toCol  =document.getElementById('to-col');
  function toggle(){
    const p=sel.value;
    const show = p==='custom';
    fromCol.classList.toggle('d-none',!show);
    toCol.classList.toggle('d-none',!show);
  }
  sel.addEventListener('change',toggle);
  toggle();   // init
});
</script>
{% endblock %}
